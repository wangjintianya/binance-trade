# 需求文档

## 简介

币安U本位合约交易系统是对现有现货交易系统的扩展，支持USDT保证金的永续合约和交割合约交易。该系统将复制现货交易的所有核心功能，并添加合约交易特有的功能，如杠杆管理、持仓管理、资金费率处理等。系统将提供独立的入口点，允许用户同时运行现货和合约交易，或单独运行其中一种。

## 术语表

- **合约交易系统 (Futures Trading System)**: 本文档描述的币安U本位合约交易应用程序
- **币安合约 (Binance Futures)**: 币安的合约交易平台
- **U本位合约 (USDT-M Futures)**: 使用USDT作为保证金的合约产品
- **永续合约 (Perpetual Contract)**: 没有到期日的合约产品
- **交割合约 (Delivery Contract)**: 有固定到期日的合约产品
- **杠杆 (Leverage)**: 放大交易规模的倍数（1x-125x）
- **保证金 (Margin)**: 开仓所需的抵押资金
- **持仓 (Position)**: 当前持有的合约头寸
- **多头 (Long Position)**: 买入合约，预期价格上涨
- **空头 (Short Position)**: 卖出合约，预期价格下跌
- **强平价格 (Liquidation Price)**: 触发强制平仓的价格水平
- **资金费率 (Funding Rate)**: 永续合约中多空双方之间的定期支付
- **标记价格 (Mark Price)**: 用于计算未实现盈亏和强平价格的公允价格
- **仓位模式 (Position Mode)**: 单向持仓或双向持仓模式
- **保证金模式 (Margin Mode)**: 全仓保证金或逐仓保证金模式
- **未实现盈亏 (Unrealized PnL)**: 当前持仓的浮动盈亏
- **已实现盈亏 (Realized PnL)**: 已平仓的实际盈亏

## 需求

### 需求 1

**用户故事:** 作为合约交易者，我希望能够安全地连接到币安合约API，以便系统可以代表我执行合约交易操作。

#### 验收标准

1. WHEN 用户提供API密钥和API密钥时，THEN 合约交易系统 SHALL 验证凭证对合约API的有效性
2. WHEN API凭证无效时，THEN 合约交易系统 SHALL 拒绝连接并返回明确的错误消息
3. WHEN 建立连接时，THEN 合约交易系统 SHALL 使用HTTPS协议连接到币安合约API端点
4. WHEN 发送合约API请求时，THEN 合约交易系统 SHALL 使用HMAC SHA256算法对请求进行签名
5. WHEN API密钥存储在系统中时，THEN 合约交易系统 SHALL 使用环境变量或加密配置文件存储敏感信息

### 需求 2

**用户故事:** 作为合约交易者，我希望能够获取合约市场数据，以便分析市场并做出交易决策。

#### 验收标准

1. WHEN 用户请求特定合约的当前价格时，THEN 合约交易系统 SHALL 返回最新的标记价格和最新成交价
2. WHEN 用户请求合约K线数据时，THEN 合约交易系统 SHALL 返回指定时间间隔和时间范围的历史价格数据
3. WHEN 用户请求账户余额时，THEN 合约交易系统 SHALL 返回USDT余额和可用保证金
4. WHEN 用户请求资金费率时，THEN 合约交易系统 SHALL 返回当前和预测的资金费率
5. WHEN 合约市场数据请求失败时，THEN 合约交易系统 SHALL 重试最多三次，每次间隔递增

### 需求 3

**用户故事:** 作为合约交易者，我希望能够配置杠杆和保证金模式，以便控制交易风险和资金使用效率。

#### 验收标准

1. WHEN 用户设置合约杠杆倍数时，THEN 合约交易系统 SHALL 验证杠杆值在1到125之间
2. WHEN 用户切换保证金模式时，THEN 合约交易系统 SHALL 在无持仓时允许在全仓和逐仓之间切换
3. WHEN 用户切换仓位模式时，THEN 合约交易系统 SHALL 在无持仓时允许在单向持仓和双向持仓之间切换
4. WHEN 杠杆设置成功时，THEN 合约交易系统 SHALL 返回确认信息和当前杠杆配置
5. WHEN 用户在有持仓时尝试切换模式时，THEN 合约交易系统 SHALL 拒绝操作并返回错误消息

### 需求 4

**用户故事:** 作为合约交易者，我希望能够开仓和平仓，以便执行合约交易策略。

#### 验收标准

1. WHEN 用户创建市价开多单时，THEN 合约交易系统 SHALL 以当前市场价格执行买入开仓操作
2. WHEN 用户创建限价开空单时，THEN 合约交易系统 SHALL 在价格达到指定水平时执行卖出开仓操作
3. WHEN 用户平仓时，THEN 合约交易系统 SHALL 执行与持仓方向相反的订单以关闭持仓
4. WHEN 订单创建成功时，THEN 合约交易系统 SHALL 返回包含订单ID、状态、执行价格和持仓信息的确认
5. WHEN 用户指定的数量超过最大杠杆允许的规模时，THEN 合约交易系统 SHALL 拒绝订单并返回保证金不足错误

### 需求 5

**用户故事:** 作为合约交易者，我希望能够查询和管理持仓，以便监控风险和盈亏情况。

#### 验收标准

1. WHEN 用户请求查看当前持仓时，THEN 合约交易系统 SHALL 返回所有持仓的详细信息包括数量、开仓价格、标记价格、未实现盈亏和强平价格
2. WHEN 用户请求持仓历史时，THEN 合约交易系统 SHALL 返回指定时间范围内的已平仓记录和已实现盈亏
3. WHEN 用户查询特定合约的持仓时，THEN 合约交易系统 SHALL 返回该合约的多头和空头持仓信息
4. WHEN 持仓的标记价格更新时，THEN 合约交易系统 SHALL 重新计算未实现盈亏和强平价格
5. WHEN 用户在双向持仓模式下时，THEN 合约交易系统 SHALL 分别显示多头和空头持仓

### 需求 6

**用户故事:** 作为合约交易者，我希望系统具有合约特定的风险控制机制，以便保护资金免受强平和过度风险的影响。

#### 验收标准

1. WHEN 开仓后的强平价格过于接近当前价格时，THEN 合约交易系统 SHALL 警告用户风险过高
2. WHEN 账户保证金率低于维持保证金率时，THEN 合约交易系统 SHALL 发出强平警告
3. WHEN 单笔订单价值超过配置的最大限额时，THEN 合约交易系统 SHALL 拒绝该订单
4. WHEN 总持仓价值超过配置的最大风险敞口时，THEN 合约交易系统 SHALL 阻止新的开仓订单
5. WHEN 检测到异常的资金费率时，THEN 合约交易系统 SHALL 记录警告信息

### 需求 7

**用户故事:** 作为合约交易者，我希望能够设置合约订单的止损和止盈，以便自动管理持仓风险。

#### 验收标准

1. WHEN 用户为多头持仓设置止损价格时，THEN 合约交易系统 SHALL 在标记价格跌破止损价格时自动平仓
2. WHEN 用户为空头持仓设置止损价格时，THEN 合约交易系统 SHALL 在标记价格突破止损价格时自动平仓
3. WHEN 用户设置止盈价格时，THEN 合约交易系统 SHALL 在标记价格达到目标时自动平仓
4. WHEN 用户同时设置止损和止盈时，THEN 合约交易系统 SHALL 在任一条件触发后取消另一个订单
5. WHEN 用户设置移动止损时，THEN 合约交易系统 SHALL 根据价格向有利方向移动自动调整止损价格

### 需求 8

**用户故事:** 作为合约交易者，我希望能够设置条件触发订单，以便在市场达到特定条件时自动开仓或平仓。

#### 验收标准

1. WHEN 用户创建价格触发的开仓订单时，THEN 合约交易系统 SHALL 持续监控标记价格直到达到触发条件
2. WHEN 标记价格达到或超过触发价格时，THEN 合约交易系统 SHALL 立即执行预设的合约订单
3. WHEN 用户创建基于持仓盈亏的触发订单时，THEN 合约交易系统 SHALL 监控未实现盈亏并在达到阈值时触发
4. WHEN 用户创建基于资金费率的触发订单时，THEN 合约交易系统 SHALL 监控资金费率变化并在达到阈值时触发
5. WHEN 触发条件满足时，THEN 合约交易系统 SHALL 在3秒内执行订单并记录触发详情

### 需求 9

**用户故事:** 作为系统管理员，我希望合约交易系统能够记录所有交易活动，以便进行审计和性能分析。

#### 验收标准

1. WHEN 系统执行任何合约API操作时，THEN 合约交易系统 SHALL 记录操作类型、时间戳和结果
2. WHEN 订单被创建、执行或取消时，THEN 合约交易系统 SHALL 记录完整的订单详情和持仓变化
3. WHEN 持仓被强平时，THEN 合约交易系统 SHALL 记录强平原因、强平价格和损失金额
4. WHEN 资金费率结算时，THEN 合约交易系统 SHALL 记录支付或收取的资金费用
5. WHEN 记录敏感信息时，THEN 合约交易系统 SHALL 屏蔽API密钥和其他敏感数据

### 需求 10

**用户故事:** 作为开发者，我希望合约交易系统与现货交易系统共享核心组件，以便减少代码重复并保持一致性。

#### 验收标准

1. WHEN 两个系统使用相同的功能时，THEN 合约交易系统 SHALL 复用现货系统的通用组件
2. WHEN 合约特定功能被实现时，THEN 合约交易系统 SHALL 使用独立的模块而不影响现货系统
3. WHEN 配置文件被加载时，THEN 合约交易系统 SHALL 支持独立的配置段用于合约特定参数
4. WHEN 日志被记录时，THEN 合约交易系统 SHALL 使用统一的日志格式并标记交易类型
5. WHEN 系统启动时，THEN 合约交易系统 SHALL 提供独立的命令行入口点

### 需求 11

**用户故事:** 作为交易者，我希望能够同时运行现货和合约交易系统，以便执行跨市场套利策略。

#### 验收标准

1. WHEN 用户启动现货交易入口时，THEN 系统 SHALL 只初始化现货交易相关组件
2. WHEN 用户启动合约交易入口时，THEN 系统 SHALL 只初始化合约交易相关组件
3. WHEN 用户同时运行两个入口时，THEN 系统 SHALL 允许两个进程独立运行而不冲突
4. WHEN 两个系统共享配置文件时，THEN 系统 SHALL 正确加载各自的配置段
5. WHEN 两个系统写入日志时，THEN 系统 SHALL 使用不同的日志文件或明确的标记区分交易类型

### 需求 12

**用户故事:** 作为合约交易者，我希望系统能够处理资金费率结算，以便准确跟踪持仓成本。

#### 验收标准

1. WHEN 资金费率结算时间到达时，THEN 合约交易系统 SHALL 自动查询结算的资金费用
2. WHEN 用户持有多头且资金费率为正时，THEN 合约交易系统 SHALL 记录支付的资金费用
3. WHEN 用户持有空头且资金费率为正时，THEN 合约交易系统 SHALL 记录收取的资金费用
4. WHEN 资金费用结算后时，THEN 合约交易系统 SHALL 更新账户余额和持仓成本
5. WHEN 用户查询资金费率历史时，THEN 合约交易系统 SHALL 返回指定时间范围内的所有结算记录
