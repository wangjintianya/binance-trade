# 实现计划

- [x] 1. 重构现有代码以支持代码复用










  - 将现有的BinanceClient重命名为SpotClient，提取共享接口
  - 将TradingService重命名为SpotTradingService
  - 提取共享组件（AuthManager、RateLimiter、Logger、TriggerEngine）到独立模块
  - 更新配置结构支持多配置段（spot和futures）
  - 更新日志系统添加交易类型标记
  - _需求: 10.1, 10.2, 10.3, 10.4_

- [x] 2. 实现合约API客户端基础设施











  - 创建FuturesClient接口和实现
  - 实现合约API端点配置（https://fapi.binance.com）
  - 复用AuthManager进行请求签名
  - 实现合约特定的错误类型和错误处理
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [x] 2.1 编写属性测试：合约API凭证验证

  - **属性 1: 合约API凭证验证**
  - **验证: 需求 1.1, 1.2**

- [x] 2.2 编写属性测试：HTTPS协议强制使用

  - **属性 2: HTTPS协议强制使用**
  - **验证: 需求 1.3**

- [x] 2.3 编写属性测试：请求签名正确性

  - **属性 3: 请求签名正确性**
  - **验证: 需求 1.4**
-

- [x] 3. 实现合约市场数据服务








  - 创建FuturesMarketDataService接口和实现
  - 实现获取标记价格和最新成交价
  - 实现获取合约K线数据
  - 实现获取资金费率（当前和历史）
  - 实现市场数据缓存策略
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3.1 编写属性测试：价格数据结构完整性


  - **属性 4: 价格数据结构完整性**
  - **验证: 需求 2.1**

- [x] 3.2 编写属性测试：K线数据范围一致性


  - **属性 5: K线数据范围一致性**
  - **验证: 需求 2.2**

- [x] 3.3 编写属性测试：合约余额数据完整性


  - **属性 6: 合约余额数据完整性**
  - **验证: 需求 2.3**

- [x] 3.4 编写属性测试：资金费率数据完整性


  - **属性 7: 资金费率数据完整性**
  - **验证: 需求 2.4**

- [x] 3.5 编写属性测试：重试机制正确性


  - **属性 8: 重试机制正确性**
  - **验证: 需求 2.5**

- [x] 4. 实现杠杆和保证金管理
























  - 实现设置杠杆功能（1-125x验证）
  - 实现切换保证金模式（全仓/逐仓）
  - 实现切换仓位模式（单向/双向持仓）
  - 实现获取当前杠杆和模式配置
  - 实现持仓状态检查（切换模式前验证）
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_


- [x] 4.1 编写属性测试：杠杆值范围验证









  - **属性 9: 杠杆值范围验证**
  - **验证: 需求 3.1**

- [x] 4.2 编写属性测试：保证金模式切换条件


  - **属性 10: 保证金模式切换条件**
  - **验证: 需求 3.2, 3.5**

- [x] 4.3 编写属性测试：仓位模式切换条件


  - **属性 11: 仓位模式切换条件**
  - **验证: 需求 3.3, 3.5**

- [x] 4.4 编写属性测试：杠杆设置响应完整性


  - **属性 12: 杠杆设置响应完整性**
  - **验证: 需求 3.4**
-
-

- [x] 5. 实现合约订单管理









  - 创建FuturesTradingService接口和实现
  - 实现开多仓（市价和限价）
  - 实现开空仓（市价和限价）
  - 实现平仓功能
  - 实现订单查询和取消
  - 创建FuturesOrderRepository进行订单持久化
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5.1 编写属性测试：市价开多单参数正确性
  - **属性 13: 市价开多单参数正确性**
  - **验证: 需求 4.1**

- [x] 5.2 编写属性测试：限价开空单参数完整性


  - **属性 14: 限价开空单参数完整性**
  - **验证: 需求 4.2**

- [x] 5.3 编写属性测试：平仓方向正确性


  - **属性 15: 平仓方向正确性**
  - **验证: 需求 4.3**

- [x] 5.4 编写属性测试：合约订单响应完整性


  - **属性 16: 合约订单响应完整性**
  - **验证: 需求 4.4**

- [x] 5.5 编写属性测试：保证金充足性检查


  - **属性 17: 保证金充足性检查**
  - **验证: 需求 4.5**

- [x] 6. 实现持仓管理系统











  - 创建FuturesPositionManager接口和实现
  - 实现持仓查询（单个和全部）
  - 实现未实现盈亏计算
  - 实现强平价格计算
  - 实现保证金率计算
  - 实现持仓更新和同步
  - 创建FuturesPositionRepository进行持仓数据持久化
  - 实现持仓历史查询
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6.1 编写属性测试：持仓查询响应完整性


  - **属性 18: 持仓查询响应完整性**
  - **验证: 需求 5.1**

- [x] 6.2 编写属性测试：持仓历史时间过滤

  - **属性 19: 持仓历史时间过滤**
  - **验证: 需求 5.2**

- [x] 6.3 编写属性测试：特定合约持仓过滤

  - **属性 20: 特定合约持仓过滤**
  - **验证: 需求 5.3**

- [x] 6.4 编写属性测试：持仓盈亏计算正确性

  - **属性 21: 持仓盈亏计算正确性**
  - **验证: 需求 5.4**

- [x] 6.5 编写属性测试：双向持仓分离显示

  - **属性 22: 双向持仓分离显示**
  - **验证: 需求 5.5**
- [x] 7. 实现合约风险管理系统






- [ ] 7. 实现合约风险管理系统

  - 创建FuturesRiskManager接口和实现
  - 实现订单验证（金额、保证金、持仓限制）
  - 实现强平风险检查和警告
  - 实现保证金率监控和警告
  - 实现持仓总量限制
  - 实现异常资金费率监控
  - 实现风险指标计算和报告
  - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7.1 编写属性测试：强平风险警告


  - **属性 23: 强平风险警告**
  - **验证: 需求 6.1**

- [x] 7.2 编写属性测试：保证金率警告

  - **属性 24: 保证金率警告**
  - **验证: 需求 6.2**

- [x] 7.3 编写属性测试：订单价值限制

  - **属性 25: 订单价值限制**
  - **验证: 需求 6.3**

- [x] 7.4 编写属性测试：持仓总量限制

  - **属性 26: 持仓总量限制**
  - **验证: 需求 6.4**

- [x] 7.5 编写属性测试：异常资金费率日志

  - **属性 27: 异常资金费率日志**
  - **验证: 需求 6.5**

- [x] 8. 检查点 - 确保所有测试通过





  - 确保所有测试通过，如有问题请询问用户
- [x] 9. 实现合约止损止盈服务







- [ ] 9. 实现合约止损止盈服务

  - 创建FuturesStopLossService接口和实现
  - 实现多头止损设置和触发逻辑
  - 实现空头止损设置和触发逻辑
  - 实现止盈设置和触发逻辑
  - 实现止损止盈配对和互斥逻辑
  - 实现移动止损（trailing stop）
  - 实现止损订单管理（查询、取消、更新）
  - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9.1 编写属性测试：多头止损触发正确性


  - **属性 28: 多头止损触发正确性**
  - **验证: 需求 7.1**

- [x] 9.2 编写属性测试：空头止损触发正确性

  - **属性 29: 空头止损触发正确性**
  - **验证: 需求 7.2**

- [x] 9.3 编写属性测试：止盈触发正确性

  - **属性 30: 止盈触发正确性**
  - **验证: 需求 7.3**

- [x] 9.4 编写属性测试：止损止盈互斥性

  - **属性 31: 止损止盈互斥性**
  - **验证: 需求 7.4**

- [x] 9.5 编写属性测试：移动止损价格调整

  - **属性 32: 移动止损价格调整**
  - **验证: 需求 7.5**

- [x] 10. 实现合约条件订单服务











  - 创建FuturesConditionalOrderService接口和实现
  - 扩展TriggerEngine支持合约特定触发类型（标记价格、盈亏、资金费率）
  - 实现条件订单创建和管理
  - 实现条件订单监控引擎
  - 实现标记价格触发逻辑
  - 实现盈亏触发逻辑
  - 实现资金费率触发逻辑
  - 实现条件订单历史查询
  - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 10.1 编写属性测试：标记价格触发监控



  - **属性 33: 标记价格触发监控**
  - **验证: 需求 8.1, 8.2**

- [x] 10.2 编写属性测试：盈亏触发监控


  - **属性 34: 盈亏触发监控**
  - **验证: 需求 8.3**

- [x] 10.3 编写属性测试：资金费率触发监控


  - **属性 35: 资金费率触发监控**
  - **验证: 需求 8.4**

- [x] 10.4 编写属性测试：触发事件日志完整性


  - **属性 36: 触发事件日志完整性**
  - **验证: 需求 8.5**
- [x] 11. 实现资金费率处理系统




- [ ] 11. 实现资金费率处理系统


  - 实现资金费率定时查询
  - 实现资金费用计算（多头和空头）
  - 实现资金费用结算后的余额和成本更新
  - 实现资金费率历史查询
  - 实现资金费率结算日志记录
  - _需求: 12.1, 12.2, 12.3, 12.4, 12.5_

- [x] 11.1 编写属性测试：资金费率结算触发


  - **属性 45: 资金费率结算触发**
  - **验证: 需求 12.1**

- [x] 11.2 编写属性测试：多头资金费用计算

  - **属性 46: 多头资金费用计算**
  - **验证: 需求 12.2**

- [x] 11.3 编写属性测试：空头资金费用计算

  - **属性 47: 空头资金费用计算**
  - **验证: 需求 12.3**

- [x] 11.4 编写属性测试：资金费用结算后状态更新

  - **属性 48: 资金费用结算后状态更新**
  - **验证: 需求 12.4**

- [x] 11.5 编写属性测试：资金费率历史时间过滤

  - **属性 49: 资金费率历史时间过滤**
  - **验证: 需求 12.5**

- [x] 12. 实现日志系统增强







  - 扩展Logger支持交易类型标记
  - 实现合约API操作日志
  - 实现订单事件日志（包含持仓变化）
  - 实现强平事件日志
  - 实现资金费率结算日志
  - 确保敏感信息屏蔽
  - 支持独立的日志文件（spot和futures）
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5, 10.4, 11.5_

- [x] 12.1 编写属性测试：合约API操作日志完整性


  - **属性 37: 合约API操作日志完整性**
  - **验证: 需求 9.1**

- [x] 12.2 编写属性测试：订单事件日志完整性


  - **属性 38: 订单事件日志完整性**
  - **验证: 需求 9.2**

- [x] 12.3 编写属性测试：强平事件日志完整性


  - **属性 39: 强平事件日志完整性**
  - **验证: 需求 9.3**

- [x] 12.4 编写属性测试：资金费率结算日志完整性


  - **属性 40: 资金费率结算日志完整性**
  - **验证: 需求 9.4**

- [x] 12.5 编写属性测试：敏感信息屏蔽


  - **属性 41: 敏感信息屏蔽**
  - **验证: 需求 9.5**

- [x] 12.6 编写属性测试：日志交易类型标记


  - **属性 43: 日志交易类型标记**
  - **验证: 需求 10.4, 11.5**

- [x] 13. 实现配置管理增强









  - 扩展配置结构支持futures配置段
  - 实现合约配置加载和验证
  - 实现配置段独立加载（spot和futures）
  - 更新配置示例文件
  - 实现配置迁移工具（可选）
  - _需求: 10.3, 11.4_

- [x] 13.1 编写属性测试：合约配置加载正确性


  - **属性 42: 合约配置加载正确性**
  - **验证: 需求 10.3**

- [x] 13.2 编写属性测试：配置段独立加载








  - **属性 44: 配置段独立加载**
  - **验证: 需求 11.4**

-

- [x] 14. 实现双入口点系统




















  - 重构cmd/main.go支持子命令（spot和futures）
  - 实现现货交易入口点（只初始化现货组件）
  - 实现合约交易入口点（只初始化合约组件）
  - 实现组件工厂模式根据交易类型创建相应组件
  - 更新构建脚本和文档
  - _需求: 10.5, 11.1, 11.2, 11.3_

- [x] 14.1 编写单元测试：现货入口点初始化






  - 验证现货入口只初始化现货组件
  - _需求: 11.1_

- [x] 14.2 编写单元测试：合约入口点初始化







  - 验证合约入口只初始化合约组件
  - _需求: 11.2_
- [x] 15. 更新文档和示例








- [ ] 15. 更新文档和示例












  - 更新README.md添加合约交易说明
  - 更新API.md添加合约API文档
  - 更新EXAMPLES.md添加合约交易示例
  - 创建config.example.yaml包含合约配置
  - 创建合约交易快速入门指南
- [-] 16. 最终检查点 - 确保所有测试通过



- [-] 16. 最终检查点 - 确保所有测试通过


  - 确保所有测试通过，如有问题请询问用户
